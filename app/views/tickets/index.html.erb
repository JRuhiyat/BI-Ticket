<div class="dashboard-header">
  <h1 class="dashboard-title">Tickets List</h1>
</div>

<!-- Filters -->
<div class="filter-section">
  <h3>Filter Tickets</h3>
  <%= form_with url: tickets_path, method: :get, local: true, class: "filter-form" do |form| %>
    <div class="filter-row">
      <div class="filter-group">
        <%= form.label :category_id, "Category" %>
        <%= form.select :category_id, 
            options_from_collection_for_select(@categories, :id, :name, @category_filter),
            { include_blank: "All Categories" },
            { class: "form-select" } %>
      </div>
      
      <div class="filter-group">
        <%= form.label :item_affected_id, "Item Affected" %>
        <%= form.select :item_affected_id,
            options_from_collection_for_select(@item_affecteds, :id, :name, @item_affected_filter),
            { include_blank: "All Items" },
            { class: "form-select" } %>
      </div>
      
      <div class="filter-group">
        <%= form.label :search, "Search" %>
        <%= form.text_field :search, 
            value: @search,
            placeholder: "Search by Req. No, User Name, Summary, Status...",
            class: "search-box" %>
      </div>
    </div>
    
    <div class="filter-actions">
      <%= form.submit "Apply Filters", class: "btn btn-primary" %>
      <%= link_to "Clear Filters", tickets_path, class: "btn", style: "background: #6c757d; color: white;" %>
    </div>
  <% end %>
</div>

<!-- Tickets Table -->
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Req. No</th>
        <th>Group</th>
        <th>Priority</th>
        <th>Request Date</th>
        <th>User ID</th>
        <th>User Name</th>
        <th>User Location</th>
        <th>Assigned Group</th>
        <th>Handler/Approver</th>
        <th>Summary</th>
        <th>Age</th>
        <th>Status</th>
        <th>Category</th>
        <th>Item Affected</th>
        <th>Type</th>
        <th>Last Comment</th>
        <th>Resolution Desc</th>
        <th>Change Type</th>
        <th>Risk Level</th>
        <th>Change Date</th>
        <th>Modified Date</th>
        <th>Timeline</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.each do |ticket| %>
        <tr>
          <td><%= ticket.req_no %></td>
          <td><%= ticket.group %></td>
          <td><%= ticket.priority %></td>
          <td><%= ticket.request_date&.strftime("%Y-%m-%d") || "N/A" %></td>
          <td><%= ticket.user_id %></td>
          <td><%= ticket.user_name %></td>
          <td><%= ticket.user_location %></td>
          <td><%= ticket.assigned_group %></td>
          <td><%= ticket.handler_approver %></td>
          <td><%= truncate(ticket.summary, length: 50) %></td>
          <td><%= ticket.age %></td>
          <td>
            <span class="status-badge <%= ticket.completed? ? 'completed' : 'not-completed' %>">
              <%= ticket.status || "N/A" %>
            </span>
          </td>
          <td><%= ticket.category&.name || "N/A" %></td>
          <td><%= ticket.item_affected&.name || "N/A" %></td>
          <td><%= ticket.ticket_type %></td>
          <td><%= truncate(ticket.last_comment, length: 30) %></td>
          <td><%= truncate(ticket.resolution_desc, length: 30) %></td>
          <td><%= ticket.change_type %></td>
          <td><%= ticket.risk_level %></td>
          <td><%= ticket.change_date&.strftime("%Y-%m-%d") || "N/A" %></td>
          <td><%= ticket.modified_date&.strftime("%Y-%m-%d") || "N/A" %></td>
          <td><%= ticket.timeline_display %></td>
        </tr>
      <% end %>
      <% if @tickets.empty? %>
        <tr>
          <td colspan="22" style="text-align: center; padding: 2rem; color: #999;">
            No tickets found. <%= link_to "Upload an Excel file", new_upload_path %> to get started.
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  
  <% if defined?(Kaminari) && @tickets.respond_to?(:current_page) %>
    <div class="pagination">
      <%= paginate @tickets %>
    </div>
  <% end %>
</div>
