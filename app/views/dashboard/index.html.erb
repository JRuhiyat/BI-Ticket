<div class="dashboard-header">
  <h1 class="dashboard-title">BI Dashboard</h1>
</div>

<!-- Filters -->
<div class="filter-section">
  <h3>General Dashboard Filter</h3>
  <%= form_with url: dashboard_path, method: :get, local: true, class: "filter-form" do |form| %>
    <div class="filter-row">
      <div class="filter-group">
        <%= form.label :category_id, "Category" %>
        <%= form.select :category_id, 
            options_from_collection_for_select(@categories, :id, :name, @category_filter),
            { include_blank: "All Categories" },
            { class: "form-select" } %>
      </div>
      
      <div class="filter-group">
        <%= form.label :item_affected_id, "Item Affected" %>
        <%= form.select :item_affected_id,
            options_from_collection_for_select(@item_affecteds, :id, :name, @item_affected_filter),
            { include_blank: "All Items" },
            { class: "form-select" } %>
      </div>
      
      <div class="filter-group">
        <%= form.label :period, "Period" %>
        <%= form.select :period,
            options_for_select([["Day", "day"], ["Month", "month"], ["Year", "year"]], @period_filter),
            {},
            { class: "form-select" } %>
      </div>
    </div>
    
    <div class="filter-actions">
      <%= form.submit "Apply Filters", class: "btn btn-primary" %>
      <%= link_to "Clear Filters", dashboard_path, class: "btn", style: "background: #6c757d; color: white;" %>
    </div>
  <% end %>
</div>

<!-- Counter Cards -->
<div class="counters-grid">
  <div class="counter-card">
    <h3>Total Tickets</h3>
    <div class="value"><%= @total_tickets %></div>
  </div>
  
  <div class="counter-card completed">
    <h3>Completed Tickets</h3>
    <div class="value"><%= @completed_tickets %></div>
    <div class="sub-value"><%= number_to_percentage(@total_tickets > 0 ? (@completed_tickets.to_f / @total_tickets * 100) : 0, precision: 1) %></div>
  </div>
  
  <div class="counter-card not-completed">
    <h3>Not Completed Tickets</h3>
    <div class="value"><%= @not_completed_tickets %></div>
    <div class="sub-value"><%= number_to_percentage(@total_tickets > 0 ? (@not_completed_tickets.to_f / @total_tickets * 100) : 0, precision: 1) %></div>
  </div>
</div>

<!-- Tickets by Category Counters -->
<% if @tickets_by_category.any? %>
  <div class="filter-section">
    <h3>Tickets by Category</h3>
    <div class="counters-grid">
      <% @tickets_by_category.each do |category_name, total| %>
        <div class="counter-card">
          <h3><%= category_name %></h3>
          <div class="value"><%= total %></div>
          <div class="sub-value">
            Completed: <%= @completed_by_category[category_name] || 0 %> | 
            Not Completed: <%= @not_completed_by_category[category_name] || 0 %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Charts Grid -->
<div class="charts-grid">
  <!-- Time Series Chart -->
  <div class="chart-card full-width">
    <div class="chart-header">
      <h3>Tickets per Period (<%= @period_filter.capitalize %>)</h3>
    </div>

    <div class="chart-content">
      <% if @time_series.any? || @completed_time_series.any? %>

        <%= column_chart [
          { name: "Total Tickets", data: @time_series },
          { name: "Completed Tickets", data: @completed_time_series }
        ],
        id: "time-series-chart-canvas",
        height: "400px",
        colors: ["#667eea", "#28a745"],
        library: {
          plugins: {
            legend: {
              position: "bottom"
            }
          }
        } %>
      <% end %>
    </div>
  </div>
  
  <!-- Status Pie Chart -->
  <div class="chart-card">
    <div class="chart-header">
      <h3>Ticket Status Distribution</h3>
      <button class="chart-toggle-btn" onclick="toggleChart('status-pie-chart')" aria-label="Toggle chart">
        <span class="toggle-icon">▼</span>
      </button>
    </div>
    <div class="chart-content" id="status-pie-chart">
      <% if @status_distribution.any? %>
        <%= pie_chart @status_distribution,
            id: "status-pie-chart-canvas",
            height: "400px",
            library: {
              plugins: {
                legend: {
                  position: "right"
                }
              }
            }
          %>
      <% else %>
        <p style="text-align: center; color: #999; padding: 2rem;">No status data available.</p>
      <% end %>
    </div>
  </div>
  
  <!-- Category Pie Chart -->
  <div class="chart-card">
    <div class="chart-header">
      <h3>Ticket Category Distribution</h3>
      <button class="chart-toggle-btn" onclick="toggleChart('category-pie-chart')" aria-label="Toggle chart">
        <span class="toggle-icon">▼</span>
      </button>
    </div>
    <div class="chart-content" id="category-pie-chart">
      <% if @category_distribution.any? %>
        <%= pie_chart @category_distribution, id: "category-pie-chart-canvas", height: "400px",
          library: {
            plugins: {
              legend: {
                position: "right"
              }
            }
          } %>
      <% else %>
        <p style="text-align: center; color: #999; padding: 2rem;">No category data available.</p>
      <% end %>
    </div>
  </div>
  
  <!-- Item Affected Pie Chart -->
  <% if @item_affected_distribution.any? %>
    <div class="chart-card item-affected">
      <div class="chart-header">
        <h3>Item Affected Distribution</h3>
        <button class="chart-toggle-btn" onclick="toggleChart('item-affected-pie-chart')" aria-label="Toggle chart">
          <span class="toggle-icon">▼</span>
        </button>
      </div>
      <div class="chart-content" id="item-affected-pie-chart">
        <%= pie_chart @item_affected_distribution, id: "item-affected-pie-chart-canvas", height: "400px",
          library: {
            plugins: {
              legend: { position: "right" }
            }
          } %>
      </div>
    </div>
  <% end %>
  
  <!-- Top 10 User Locations -->
  <div class="chart-card full-width">
    <div class="chart-header">
      <h3>Top 10 User Locations
        <%= link_to "Sort ASC", dashboard_path(category_id: @category_filter, item_affected_id: @item_affected_filter, period: @period_filter, sort_order: "asc"), 
            class: "btn", style: "background: #667eea; color: white; margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;" %>
        <%= link_to "Sort DESC", dashboard_path(category_id: @category_filter, item_affected_id: @item_affected_filter, period: @period_filter, sort_order: "desc"), 
            class: "btn", style: "background: #667eea; color: white; margin-left: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;" %>
      </h3>
      <button class="chart-toggle-btn" onclick="toggleChart('user-locations-bar-chart')" aria-label="Toggle chart">
        <span class="toggle-icon">▼</span>
      </button>
    </div>
    <div class="chart-content" id="user-locations-bar-chart">
      <% if @user_locations.any? %>
        <%= bar_chart @user_locations, id: "user-locations-bar-chart-canvas", height: "400px", horizontal: true, colors: ["#667eea"] %>
      <% else %>
        <p style="text-align: center; color: #999; padding: 2rem;">No user location data available.</p>
      <% end %>
    </div>
  </div>
</div>

<script>
  function toggleChart(chartId) {
    const chartContent = document.getElementById(chartId);
    if (!chartContent) return;

    const chartCard = chartContent.closest('.chart-card');
    const toggleBtn = chartCard.querySelector('.chart-toggle-btn');
    const toggleIcon = toggleBtn.querySelector('.toggle-icon');

    if (chartContent.classList.contains('hidden')) {
      chartContent.classList.remove('hidden');
      toggleIcon.textContent = '▼';
    } else {
      chartContent.classList.add('hidden');
      toggleIcon.textContent = '▶';
    }
  }
</script>
<!-- Tickets Table -->
<div class="table-container">
  <div class="table-header">
    <h3>Tickets List</h3>
    <%= link_to "View All Tickets", tickets_path(category_id: @category_filter, item_affected_id: @item_affected_filter), 
        class: "btn btn-primary" %>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Req. No</th>
        <th>User Name</th>
        <th>Category</th>
        <th>Item Affected</th>
        <th>Status</th>
        <th>Request Date</th>
        <th>Modified Date</th>
        <th>Timeline</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.limit(10).each do |ticket| %>
        <tr>
          <td><%= ticket.req_no %></td>
          <td><%= ticket.user_name %></td>
          <td><%= ticket.category&.name || "N/A" %></td>
          <td><%= ticket.item_affected&.name || "N/A" %></td>
          <td>
            <span class="status-badge <%= ticket.completed? ? 'completed' : 'not-completed' %>">
              <%= ticket.status || "N/A" %>
            </span>
          </td>
          <td><%= ticket.request_date&.strftime("%Y-%m-%d") || "N/A" %></td>
          <td><%= ticket.modified_date&.strftime("%Y-%m-%d") || "N/A" %></td>
          <td><%= ticket.timeline_display %></td>
        </tr>
      <% end %>
      <% if @tickets.empty? %>
        <tr>
          <td colspan="8" style="text-align: center; padding: 2rem; color: #999;">
            No tickets found. Upload an Excel file to get started.
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
